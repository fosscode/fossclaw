name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  # test:
  #   name: Test
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Setup Bun
  #       uses: oven-sh/setup-bun@v1
  #       with:
  #         bun-version: latest

  #     - name: Install dependencies
  #       working-directory: web
  #       run: bun install

  #     - name: Run tests
  #       working-directory: web
  #       run: bun test

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: web
        run: bun install

      - name: Type check
        working-directory: web
        run: bun run typecheck

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: web
        run: bun install

      - name: Build frontend
        working-directory: web
        run: bun run build

      - name: Verify build output
        run: |
          if [ ! -d "web/dist" ]; then
            echo "Build failed: web/dist directory not found"
            exit 1
          fi
          echo "âœ“ Build successful"

  build-binary:
    name: Build Binary (${{ matrix.platform }}-${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: darwin
            arch: arm64
          - os: ubuntu-latest
            platform: linux
            arch: x64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Build frontend
        working-directory: web
        run: |
          bun install
          bun run build

      - name: Prepare build directory
        run: |
          mkdir -p build dist
          cat > build/entry.ts << 'EOF'
          #!/usr/bin/env bun
          process.env.__FOSSCLAW_PACKAGE_ROOT = import.meta.dir;
          import "./server/index.ts";
          EOF
          cp -r web/server build/
          cp -r web/dist build/
          cp web/package.json build/

      - name: Install server dependencies
        working-directory: build
        run: bun install

      - name: Build binary (Unix)
        working-directory: build
        run: |
          set -x
          bun build entry.ts --compile --target=bun --outfile "../dist/fossclaw-${{ matrix.platform }}-${{ matrix.arch }}" 2>&1
          ls -la ../dist/
