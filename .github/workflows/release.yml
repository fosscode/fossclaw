name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.platform }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # macOS builds (ARM64 only - macos-13 doesn't support bun)
          - os: macos-latest
            platform: darwin
            arch: arm64

          # Linux builds
          - os: ubuntu-latest
            platform: linux
            arch: x64

          # Windows builds
          - os: windows-latest
            platform: windows
            arch: x64

    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build frontend
        run: |
          cd web
          bun install
          bun run build

      - name: Prepare build directory (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p build dist
          # Create entry point
          cat > build/entry.ts << 'EOF'
          #!/usr/bin/env bun
          process.env.__FOSSCLAW_PACKAGE_ROOT = import.meta.dir;
          import "./server/index.ts";
          EOF
          # Copy files
          cp -r web/server build/
          cp -r web/dist build/
          cp web/package.json build/
          cp LICENSE build/
          cp README.md build/

      - name: Prepare build directory (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          mkdir -p build/dist
          @"
          #!/usr/bin/env bun
          process.env.__FOSSCLAW_PACKAGE_ROOT = import.meta.dir;
          import "./server/index.ts";
          "@ | Out-File -FilePath build/entry.ts -Encoding utf8
          New-Item -ItemType Directory -Force -Path build/server | Out-Null
          Copy-Item -Path web/server/* -Destination build/server/ -Recurse
          Copy-Item -Path web/dist/* -Destination build/dist/ -Recurse
          Copy-Item -Path web/package.json -Destination build/
          Copy-Item -Path LICENSE -Destination build/dist/
          Copy-Item -Path README.md -Destination build/dist/

      - name: Install build dependencies
        working-directory: build
        run: bun install

      - name: Build binary (Unix)
        if: runner.os != 'Windows'
        working-directory: build
        run: |
          bun build entry.ts --compile --target=bun --outfile "../dist/fossclaw-${{ matrix.platform }}-${{ matrix.arch }}"
          cp LICENSE ../dist/
          cp README.md ../dist/
          ls -la ../dist/

      - name: Build binary (Windows)
        if: runner.os == 'Windows'
        working-directory: build
        shell: bash
        run: |
          bun build entry.ts --compile --target=bun --outfile "../dist/fossclaw-${{ matrix.platform }}-${{ matrix.arch }}.exe"
          cp LICENSE ../dist/
          cp README.md ../dist/
          ls -la ../dist/

      - name: Create archive (Unix)
        if: runner.os != 'Windows'
        run: |
          cd dist
          sleep 2
          { tar -czf "fossclaw-v${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz" . 2>&1 || true; } | grep -v "file changed" || true
          shasum -a 256 *.tar.gz > checksums.txt

      - name: Create archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd dist
          Compress-Archive -Path "fossclaw-*.exe" -DestinationPath "fossclaw-v${{ steps.version.outputs.VERSION }}-windows-x64.zip"
          Get-ChildItem *.zip | ForEach-Object { (Get-FileHash -Path $_.FullName -Algorithm SHA256).Hash.ToLower() } > checksums.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: fossclaw-${{ matrix.platform }}-${{ matrix.arch }}
          path: dist/*

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          files: |
            artifacts/fossclaw-darwin-arm64/*
            artifacts/fossclaw-linux-x64/*
            artifacts/fossclaw-windows-x64/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release info
        run: |
          echo "âœ… Release created successfully!"
          echo "Version: ${{ steps.version.outputs.VERSION }}"
          echo "Artifacts:"
          ls -lh release/
