name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.platform }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # macOS builds (ARM64 only - macos-13 doesn't support bun)
          - os: macos-latest
            platform: darwin
            arch: arm64

          # Linux builds
          - os: ubuntu-latest
            platform: linux
            arch: x64

          # Windows builds
          - os: windows-latest
            platform: windows
            arch: x64

    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build frontend
        run: |
          cd web
          bun install
          bun run build

      - name: Prepare build directory (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p build dist
          # Create entry point with wrapper script support
          cat > build/entry.ts << 'EOF'
          #!/usr/bin/env bun
          // FossClaw Standalone Entry Point
          // __FOSSCLAW_PACKAGE_ROOT will be set by the wrapper script
          // If not set (running directly), fall back to current directory
          if (!process.env.__FOSSCLAW_PACKAGE_ROOT) {
            process.env.__FOSSCLAW_PACKAGE_ROOT = import.meta.dir;
          }
          // ALWAYS force NODE_ENV to production in compiled binary
          process.env.NODE_ENV = "production";

          import "./server/index.ts";
          EOF
          # Copy files
          cp -r web/server build/
          cp -r web/dist build/
          cp web/package.json build/
          cp LICENSE build/
          cp README.md build/
          # Update version in package.json to match the tag
          node -e "const fs=require('fs');const p='build/package.json';const d=JSON.parse(fs.readFileSync(p,'utf8'));d.version='${{ steps.version.outputs.VERSION }}';fs.writeFileSync(p,JSON.stringify(d,null,2)+'\n');"

      - name: Prepare build directory (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          mkdir -p build/dist
          @"
          #!/usr/bin/env bun
          process.env.__FOSSCLAW_PACKAGE_ROOT = import.meta.dir;
          import "./server/index.ts";
          "@ | Out-File -FilePath build/entry.ts -Encoding utf8
          New-Item -ItemType Directory -Force -Path build/server | Out-Null
          Copy-Item -Path web/server/* -Destination build/server/ -Recurse
          Copy-Item -Path web/dist/* -Destination build/dist/ -Recurse
          Copy-Item -Path web/package.json -Destination build/
          Copy-Item -Path LICENSE -Destination build/
          Copy-Item -Path README.md -Destination build/
          # Update version in package.json to match the tag
          (Get-Content build/package.json) -replace '"version": ".*"', '"version": "${{ steps.version.outputs.VERSION }}"' | Set-Content build/package.json

      - name: Install build dependencies
        working-directory: build
        run: bun install

      - name: Build binary (Unix)
        if: runner.os != 'Windows'
        working-directory: build
        run: |
          # Build the binary with .bin extension
          bun build entry.ts --compile --target=bun --outfile "../dist/fossclaw-${{ matrix.platform }}-${{ matrix.arch }}.bin"
          chmod +x "../dist/fossclaw-${{ matrix.platform }}-${{ matrix.arch }}.bin"

          # Create wrapper script
          cat > "../dist/fossclaw-${{ matrix.platform }}-${{ matrix.arch }}" << 'WRAPPER_EOF'
          #!/bin/bash
          # FossClaw wrapper script - determines the directory where this script lives
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export __FOSSCLAW_PACKAGE_ROOT="$SCRIPT_DIR"
          export NODE_ENV=production
          exec "$SCRIPT_DIR/$(basename "$0").bin" "$@"
          WRAPPER_EOF

          chmod +x "../dist/fossclaw-${{ matrix.platform }}-${{ matrix.arch }}"

          # Copy dist folder and other files
          cp -r dist ../dist/dist
          cp LICENSE ../dist/
          cp README.md ../dist/
          ls -la ../dist/

      - name: Build binary (Windows)
        if: runner.os == 'Windows'
        working-directory: build
        shell: bash
        run: |
          bun build entry.ts --compile --target=bun --outfile "../dist/fossclaw-${{ matrix.platform }}-${{ matrix.arch }}.exe"
          cp LICENSE ../dist/
          cp README.md ../dist/
          ls -la ../dist/

      - name: Create archives (Unix)
        if: runner.os != 'Windows'
        run: |
          cd dist
          sleep 2
          # Create versioned archive with wrapper, .bin, and dist folder
          { tar -czf "fossclaw-v${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz" \
            "fossclaw-${{ matrix.platform }}-${{ matrix.arch }}" \
            "fossclaw-${{ matrix.platform }}-${{ matrix.arch }}.bin" \
            dist \
            LICENSE \
            README.md \
            2>&1 || true; } | grep -v "file changed" || true
          # Latest archive (without version)
          { tar -czf "fossclaw-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz" \
            "fossclaw-${{ matrix.platform }}-${{ matrix.arch }}" \
            "fossclaw-${{ matrix.platform }}-${{ matrix.arch }}.bin" \
            dist \
            LICENSE \
            README.md \
            2>&1 || true; } | grep -v "file changed" || true
          shasum -a 256 *.tar.gz > checksums.txt

      - name: Create archives (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd dist
          # Versioned archive
          Compress-Archive -Path "fossclaw-*.exe" -DestinationPath "fossclaw-v${{ steps.version.outputs.VERSION }}-windows-x64.zip"
          # Latest archive (without version)
          Compress-Archive -Path "fossclaw-*.exe" -DestinationPath "fossclaw-windows-x64.zip"
          Get-ChildItem *.zip | ForEach-Object { (Get-FileHash -Path $_.FullName -Algorithm SHA256).Hash.ToLower() } > checksums.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: fossclaw-${{ matrix.platform }}-${{ matrix.arch }}
          path: dist/*

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          files: |
            artifacts/fossclaw-darwin-arm64/fossclaw-*
            artifacts/fossclaw-linux-x64/fossclaw-*
            artifacts/fossclaw-windows-x64/fossclaw-*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release info
        run: |
          echo "âœ… Release created successfully!"
          echo "Version: ${{ steps.version.outputs.VERSION }}"
